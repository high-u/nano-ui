<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kanban - nanoui</title>
    <style>
      body {
        font-family: system-ui, -apple-system, sans-serif;
        margin: 20px;
      }
      .controls {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .control-group {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      input, select {
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        padding: 8px 12px;
        font-size: 14px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .add-btn {
        background-color: #4CAF50;
        color: white;
      }
      .delete-btn {
        background-color: #f44336;
        color: white;
      }
      .move-btn {
        background-color: #2196F3;
        color: white;
        padding: 4px 8px;
        font-size: 12px;
      }
      .board {
        display: flex;
        gap: 16px;
        overflow-x: auto;
        padding-bottom: 16px;
      }
      .lane {
        min-width: 250px;
        background-color: #f5f5f5;
        border-radius: 8px;
        padding: 12px;
      }
      .lane-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 2px solid #ddd;
      }
      .lane-title {
        font-weight: bold;
        font-size: 16px;
      }
      .lane-delete-btn {
        background-color: #f44336;
        color: white;
        padding: 4px 8px;
        font-size: 12px;
      }
      .task-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .task {
        background-color: white;
        padding: 12px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      .task-name {
        margin-bottom: 8px;
      }
      .task-buttons {
        display: flex;
        gap: 4px;
      }
    </style>
  </head>
  <body>
    <h1>Kanban - nanoui</h1>
  </body>
  <script type="module">
    import { h, render } from '../src/nanoui-v2.js';

    // State
    let lanes = [
      { id: 0, name: 'ToDo' },
      { id: 1, name: 'Progress' },
      { id: 2, name: 'Done' }
    ];
    let tasks = [];
    let laneId = 3;
    let taskId = 0;

    // Containers
    const board = h('div', { id: 'board', class: 'board' });

    // Lane input
    const laneInput = h('input', {
      id: 'lane-input',
      type: 'text',
      placeholder: 'レーン名...'
    });

    // Lane add button
    const laneAddBtn = h('button', {
      id: 'lane-add-btn',
      class: 'add-btn',
      onClick: () => addLane()
    }, 'レーン追加');

    // Task input
    const taskInput = h('input', {
      id: 'task-input',
      type: 'text',
      placeholder: 'タスク名...'
    });

    // Lane select dropdown
    const laneSelect = h('select', { id: 'lane-select' });

    // Task add button
    const taskAddBtn = h('button', {
      id: 'task-add-btn',
      class: 'add-btn',
      onClick: () => addTask()
    }, 'タスク追加');

    // Controls
    const controls = h('div', { id: 'controls', class: 'controls' },
      h('div', { id: 'lane-controls', class: 'control-group' },
        laneInput,
        laneAddBtn
      ),
      h('div', { id: 'task-controls', class: 'control-group' },
        taskInput,
        laneSelect,
        taskAddBtn
      )
    );

    // Create task element
    function createTaskElement(task, laneIndex) {
      const isFirst = laneIndex === 0;
      const isLast = laneIndex === lanes.length - 1;

      const buttons = [];

      if (!isFirst) {
        buttons.push(h('button', {
          id: `task-left-${task.id}`,
          class: 'move-btn',
          onClick: () => moveTask(task.id, -1)
        }, '←'));
      }

      if (!isLast) {
        buttons.push(h('button', {
          id: `task-right-${task.id}`,
          class: 'move-btn',
          onClick: () => moveTask(task.id, 1)
        }, '→'));
      }

      buttons.push(h('button', {
        id: `task-delete-${task.id}`,
        class: 'delete-btn',
        onClick: () => deleteTask(task.id)
      }, '削除'));

      return h('div', { id: `task-${task.id}`, class: 'task' },
        h('div', { id: `task-name-${task.id}`, class: 'task-name' }, task.name),
        h('div', { id: `task-buttons-${task.id}`, class: 'task-buttons' }, ...buttons)
      );
    }

    // Create lane element
    function createLaneElement(lane) {
      const laneIndex = lanes.findIndex(l => l.id === lane.id);
      const laneTasks = tasks.filter(t => t.laneId === lane.id);

      return h('div', { id: `lane-${lane.id}`, class: 'lane' },
        h('div', { id: `lane-header-${lane.id}`, class: 'lane-header' },
          h('span', { id: `lane-title-${lane.id}`, class: 'lane-title' }, lane.name),
          h('button', {
            id: `lane-delete-${lane.id}`,
            class: 'lane-delete-btn',
            onClick: () => deleteLane(lane.id)
          }, '削除')
        ),
        h('div', { id: `lane-tasks-${lane.id}`, class: 'task-list' },
          ...laneTasks.map(task => createTaskElement(task, laneIndex))
        )
      );
    }

    // Renderer
    const renderBoard = render(
      board,
      () => lanes.map(lane => createLaneElement(lane))
    );

    // Update lane select options
    function updateLaneSelect() {
      laneSelect.innerHTML = '';
      lanes.forEach(lane => {
        const option = document.createElement('option');
        option.value = lane.id;
        option.textContent = lane.name;
        laneSelect.appendChild(option);
      });
    }

    // Add lane
    function addLane() {
      const name = laneInput.value.trim();
      if (!name) return;

      lanes.push({ id: laneId++, name });
      laneInput.value = '';
      updateLaneSelect();
      renderBoard();
    }

    // Delete lane
    function deleteLane(id) {
      lanes = lanes.filter(l => l.id !== id);
      tasks = tasks.filter(t => t.laneId !== id);
      updateLaneSelect();
      renderBoard();
    }

    // Add task
    function addTask() {
      const name = taskInput.value.trim();
      if (!name || lanes.length === 0) return;

      const selectedLaneId = parseInt(laneSelect.value);
      tasks.unshift({ id: taskId++, name, laneId: selectedLaneId });
      taskInput.value = '';
      renderBoard();
    }

    // Delete task
    function deleteTask(id) {
      tasks = tasks.filter(t => t.id !== id);
      renderBoard();
    }

    // Move task to adjacent lane
    function moveTask(taskId, direction) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;

      const currentLaneIndex = lanes.findIndex(l => l.id === task.laneId);
      const newLaneIndex = currentLaneIndex + direction;

      if (newLaneIndex < 0 || newLaneIndex >= lanes.length) return;

      // Remove task from current position
      tasks = tasks.filter(t => t.id !== taskId);

      // Update lane and add to beginning
      task.laneId = lanes[newLaneIndex].id;
      tasks.unshift(task);

      renderBoard();
    }

    // Append to body
    document.body.append(controls, board);

    // 初期レンダリング
    updateLaneSelect();
    renderBoard();
  </script>
</html>
